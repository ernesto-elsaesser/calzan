<!DOCTYPE html>
<html>
    <head>
        <title>Die Baustelle von Calzan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />

        <style>
            .player {
                width: 100px;
                height: 40px;
                font-weight: bold;
                display: inline-block;
            }
            #board {
                background-color: navy;
                width: 800px;
                height: 800px;
                margin: 20px auto;
                position: relative;
                border-radius: 400px;
            }
            #board * {
                position: absolute;
                transform: translate(-50%, -50%);
            }
            .roll { font-size: 32px; }
            .city {
                height: 30px;
                width: 30px;
                border-radius: 50%;
            }
            .town {
                height: 40px;
                width: 40px;
                border-radius: 50%;
            }
            .road {
                height: 10px;
                width: 50px;
            }
            .port {
                font-size: 20px;
                color: white;
            }
        </style>
    </head>
    <body>
        <div style="text-align: center">
            <h3>SPIELER</h3>
            <div id="players"></div>
            <div style="margin: 20px">
                Holz: <span id="Holz">0</span> Lehm: <span id="Lehm">0</span> Stroh: <span id="Stroh">0</span> Schafe: <span id="Schafe">0</span> Erz: <span id="Erz">0</span> Siegpunkte: <span id="Siegpunkte">0</span>
            </div>
            <div>WÃ¼rfel: <span id="dice">-</span></div>
            <div id="board"></div>
        </div>

        <script src="/__/firebase/8.10.1/firebase-app.js"></script>
        <script src="/__/firebase/8.10.1/firebase-database.js"></script>
        <script src="/__/firebase/init.js"></script>
        <script>

const players = document.getElementById("players");
const dice = document.getElementById("dice");
const board = document.getElementById("board");

var colorMap = {
    'Sand': 'moccasin',
    'Holz': 'darkgreen',
    'Lehm': 'chocolate',
    'Stroh': 'gold',
    'Schafe': 'greenyellow',
    'Erz': 'lightslategray',
    'Alle': 'white'
};

const angle = Math.pi / 6;
const dirs = {
    'n': 0 * angle,
    'ne': 1 * angle,
    'en': 2 * angle,
    'e': 3 * angle,
    'es': 4 * angle,
    'se': 5 * angle,
    's': 6 * angle,
    'sw': 7 * angle,
    'ws': 8 * angle,
    'w': 9 * angle,
    'wn': 10 * angle,
    'nw': 11 * angle
};

var data = null;
var chosenColor = null;

function shift(coords, dist, rads) {
    const x = coords[0] + dist * Math.sin(rads);
    const y = coords[1] + dist * Math.cos(rads);
    return [x, y]
}

function create(tag, class, coords) {
    const element = document.createElement('img');
    element.className = class;
    element.style.left = coords[0].toString() + 'px';
    element.style.top = coords[1].toString() + 'px';
    return element;
}

function drawTile(info, coords) {

    const tile = create('img', 'tile', coords);
    tile.src = 'img/' + info.type + '.svg';
    board.appendChild(tile);

    if (info.roll) {
        const roll = create('p', 'roll', coords);
        roll.innerHTML = info.roll.toString();
        board.appendChild(roll);
    }

    if (info.bandit) {
        const banditCoords = [coords[0], coords[1] - 30]
        const bandit = create('bandit', 'bandit', banditCoords);
        bandit.src = 'img/bandit.svg';
        board.appendChild(bandit);
    }

    for (const [key, rads] of Object.entries(dirs)) {
    
        if (info.tiles[key]) {
            drawTile(info.tiles[key], shift(cords, 100, rads));
        }

        if (info.towns[key]) {
            drawTown(info.towns[key], shift(cords, 80, rads));
        }

        if (info.roads[key]) {
            drawRoad(info.roads[key], shift(cords, 50, rads), rads);
        }

        if (info.ports[key]) {
            drawPort(info.ports[key], shift(cords, 100, rads), rads);
        }
    }
}

function drawTown(info, coords) {

    const className = info.city ? 'city' : 'town';
    const town = create('div', className, coords);
    town.style.backgroundColor = info.color;
    board.appendChild(town);
}

function drawRoad(info, coords, rads) {

    const road = create('div', 'road', coords);
    road.style.backgroundColor = info.color;
    road.style.transform = 'rotate(' + rads.toString() + 'rad)';
    board.appendChild(road);
}

function drawPort(info, coords, rads) {

    // TODO img
    const port = create('p', 'port', coords);
    port.innerHTML = info.trade;
    board.appendChild(port);
}

function update() {

    if (data == null) {
        return;
    }

    players.innerHTML = "";

    for (const color of Object.keys(data.players)) {
        const button = document.createElement('button');
        button.className = 'player';
        button.style.backgroundColor = color;
        button.onclick = function() { chosenColor = color; update(); };
        button.innerHTML = color == chosenColor ? '&horbar;&horbar;&horbar;&horbar;' : '&nbsp';
        players.appendChild(button);
    }

    dice.innerHTML = data.dice.toString();

    board.innerHTML = "";
    drawTile(data.root, [400, 400]);

    if (chosenColor == null) {
        return;
    }

    const stats = data.players[chosenColor];

    for (const [name, amount] of Object.entries(stats)) {
        document.getElementById(name).innerHTML = amount.toString();
    }
}

firebase.database().ref('/').on('value', (snapshot) => {
  data = snapshot.val();
  update();
});
        </script>
    </body>
</html>
