<!DOCTYPE html>
<html>
    <head>
        <title>Calzan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />
        
        <style>
            body { font-family: Arial, sans; }
            h4 { margin: 30px 0 15px; }
            #sidebar { width: 320px; height: 100%; position: fixed; top: 0; left: 0; overflow: auto; background-color: #313a35; }
            #players { margin: 20px 20px 0; color: white; }
            #log { margin: 20px; color: white; line-height: 2; }
            #content { margin-left: 320px; padding: 40px; text-align: center; }
            #canvas { max-width: 800px; margin: 0 auto 20px; }
            #actions button { margin: 10px; }
            #reference img { margin: 30px; }
            .card { margin-right: 5px; }
        </style>
    </head>
    <body>
        <div id="sidebar">
            <div id="players"></div>
            <div id="log"></div>
        </div>
        
        <div id="content">
            <form id="form">
                <h2>Neues Spiel</h2>
                <label for="game">Name:</label>
                <input type="text" id="game" name="game" value="Test" /><br><br>
                <label for="players">Spieler:</label>
                <input type="text" id="playerlist" name="playerlist" value="Anna,Bene,Cem" /><br><br>
                <input type="checkbox" id="shuffle" name="shuffle" />
                <label for="shuffle">Zuf√§llige Reihenfolge</label><br><br>
                <input type="submit" value="Erstellen">
            </form>
        
            <svg id="canvas" viewBox="0 0 1280 1200" xmlns="http://www.w3.org/2000/svg">
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Lora&display=swap');
                    .roll { font: bold 48px 'Lora', serif; }
                    .rollr { font: bold 60px 'Lora', serif; fill: firebrick; }
                    .port { font: bold 22px 'Lora', serif; letter-spacing: 2px; }
                    .portw { font: bold 22px 'Lora', serif; letter-spacing: 2px; fill: white; }
                    .player { font-weight: bold; }
                    .player0 { color: #E33E09; fill: #E33E09; }
                    .player1 { color: #1C79D5; fill: #1C79D5; }
                    .player2 { color: #FBCD19; fill: #FBCD19; }
                    .player3 { color: #8A58E8; fill: #8A58E8; }
                    .player4 { color: #EB7EC5; fill: #EB7EC5; }                
                    .tile_desert { fill: #EBE3B0; stroke: #D8CC8B; stroke-width: 5; }
                    .tile_lumber { fill: #6E9B3C; stroke: #4F702A; stroke-width: 5; }
                    .tile_brick { fill: #DF9327; stroke: #A87325; stroke-width: 5; }
                    .tile_grain { fill: #EFDA61; stroke: #CCB94C; stroke-width: 5; }
                    .tile_wool { fill: #AEE670; stroke: #89C852; stroke-width: 5; }
                    .tile_ore { fill: #A4A296; stroke: #7F7E74; stroke-width: 5; }
                    .tile_water { fill: #2D2F6C; stroke: #2D2F6C; stroke-width: 5; }
                </style>
                <g id="board"></g>
            </svg>
            
            <div id="actions"></div>
            
            <div id="info">
                <h4>Rohstoffe</h4>
                <div id="resources"></div>
                <h4>Entwicklungskarten</h4>
                <div id="cards"></div>
                <h4>Siegpunkte</h4>
                <div id="victory"></div>
            </div>
            
            <div id="reference">
                <img src="img/costs.jpg" />
                <img src="img/develop.jpg" style="width: 90%" />
                <img src="img/special.jpg" style="width: 90%" />
            </div>
        </div>

        <script src="/js/constants.js"></script>
        <script src="/js/state.js"></script>
        <script src="/js/choices.js"></script>
        <script src="/js/ui.js"></script>
        <script src="/js/length.js"></script>
        <script src="/js/game.js"></script>
        
        <script type="module">
            import { initializeApp }
                from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
            import { getDatabase, ref, child, get, set, onChildAdded }
                from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
            
            const app = initializeApp({
                apiKey: "AIzaSyCiey2Y0hYdghmZy95YrteZBPEADxbej1k",
                authDomain: "calzan.firebaseapp.com",
                databaseURL: "https://calzan-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "calzan",
                storageBucket: "calzan.appspot.com",
                messagingSenderId: "771193061461",
                appId: "1:771193061461:web:58564110d8e28f9d3d94dc"
            });

            const db = getDatabase(app);
  
            const urlParams = new URLSearchParams(window.location.search);
            const game = urlParams.get('game');
            const player = urlParams.get('player');

            const form = document.getElementById('form');
            if (game) {
                
                form.remove();
                
                const gameRef = ref(db, '/' + game);
                const eventsRef = child(gameRef, '/events');
                
                const postFunc = (eventId, event) => {
                    const eventRef = child(eventsRef, '/' + eventId.toString());
                    set(eventRef, event);
                };

                get(gameRef).then((snap) => {

                    initState(snap.val(), postFunc, player);
                    initUI(game);
                    startGame();

                    onChildAdded(eventsRef, (data) => {
                        dispatchEvent(data.key, data.val());
                    });
                });
            } else {
                
                form.addEventListener("submit", (e) => {
                    
                    e.preventDefault();
                    
                    const game = document.getElementById('game').value;
                    const playerList = document.getElementById('playerlist').value;
                    const shuffle = document.getElementById('shuffle').checked;
                    
                    const seed = Math.floor(Math.random() * 4294967296); // 2^32
                    
                    var players = playerList.split(',');
                    if (shuffle) {
                        // https://stackoverflow.com/a/2450976/4248897
                        for (var i = players.length - 1; i > 0; i -= 1) {
                            const ri = Math.floor(Math.random() * (i + 1));
                            [players[i], players[ri]] = [players[ri], players[i]];
                        }
                    }

                    const gameRef = ref(db, '/' + game);
                    set(gameRef, {seed, players, board: boardTemplate}).then(() => { 
                        window.location.href = "/?game=" + game;
                    }).catch((error) => {
                        window.alert("Ein Spiel mit diesem Namen existiert bereits.");
                    });
                });
            }
        </script>
    </body>
</html>
