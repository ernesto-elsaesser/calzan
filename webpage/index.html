<!DOCTYPE html>
<html>
    <head>
        <title>Die Baustelle von Calzan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />

        <style>
            .player {
                width: 100px;
                height: 40px;
                display: inline-block;
            }
            #board {
                background-color: deepskyblue;
                width: 640px;
                height: 640px;
                margin: 20px auto;
                position: relative;
                border-radius: 50px;
            }
            .token {
                position: absolute;
                border-radius: 50%;
            }
            .token p {
                text-align: center;
                vertical-align: center;
                height: 100%;
                font-size: 32px;
            }
            .tile {
                height: 100px;
                width: 100px;
                transform: translate(-50px, -50px);
            }
            .town {
                height: 30px;
                width: 30px;
                transform: translate(-15px, -15px);
            }
            .city {
                height: 60px;
                width: 60px;
                transform: translate(-30px, -30px);
            }
            .road {
                height: 10px;
                width: 10px;
                transform: translate(-5px, -5px);
            }
        </style>
    </head>
    <body>
        <div style="text-align: center">
            <h3>SPIELER</h3>
            <div id="players"></div>
            <div style="margin: 20px">
                Holz: <span id="Holz">0</span> Lehm: <span id="Lehm">0</span> Stroh: <span id="Stroh">0</span> Schafe: <span id="Schafe">0</span> Granit: <span id="Granit">0</span> Siegpunkte: <span id="Siegpunkte">0</span>
            </div>
            <div>WÃ¼rfel: <span id="dice">-</span></div>
            <div id="board"></div>
        </div>

        <script src="/__/firebase/8.10.1/firebase-app.js"></script>
        <script src="/__/firebase/8.10.1/firebase-database.js"></script>
        <script src="/__/firebase/init.js"></script>
        <script>

const players = document.getElementById("players");
const dice = document.getElementById("dice");
const board = document.getElementById("board");

var colorMap = {
    'Sand': 'moccasin',
    'Holz': 'darkgreen',
    'Lehm': 'chocolate',
    'Stroh': 'gold',
    'Schafe': 'chartreuse',
    'Granit': 'dimgray'
};

var data = null;
var chosenColor = null;

function createToken(cls, top, left, color, text) {
    var token = document.createElement('div');
    token.className = 'token ' + cls;
    token.style.top = top.toString() + 'px';
    token.style.left = left.toString() + 'px';
    token.style.backgroundColor = color;
    if (text != null) {
        const label = document.createElement('p');
        label.innerHTML = text;
        token.appendChild(label);
    }
    return token;
}

function update() {

    if (data == null) {
        return;
    }

    players.innerHTML = "";

    for (const color of Object.keys(data.players)) {
        const button = document.createElement('button');
        button.className = 'player';
        button.style.backgroundColor = color;
        button.onclick = function() { chosenColor = color; update(); };
        players.appendChild(button);
    }

    dice.innerHTML = data.dice.toString();

    board.innerHTML = "";

    for (const tileData of Object.values(data.tiles)) {
        const tileColor = colorMap[tileData.type];
        const top = 110 + (tileData.y * 100);
        const left = 80 + (tileData.x * 60);
        const text = tileData.num > 0 ? tileData.num.toString(): null;
        const tile = createToken('tile', top, left, tileColor, text);
        board.appendChild(tile);

        if (tileData.above.color) {
            const aboveClass = tileData.above.city ? 'city' : 'town';
            const above = createToken(aboveClass, top - 68, left,
                                        tileData.above.color);
            board.appendChild(above);
        }

        if (tileData.below.color) {
            const belowClass = tileData.below.city ? 'city' : 'town';
            const below = createToken(belowClass, top + 68, left,
                                        tileData.below.color);
            board.appendChild(below);
        }

        if (tileData.right.color) {
            const right = createToken('road', top, left - 60,
                                        tileData.right.color);
            board.appendChild(right);
        }

        if (tileData.upright.color) {
            const upright = createToken('road', top - 50, left - 30,
                                        tileData.upright.color);
            board.appendChild(upright);
        }

        if (tileData.lowright.color) {
            const lowright = createToken('road', top + 50, left - 30,
                                        tileData.lowright.color);
            board.appendChild(lowright);
        }
    }

    if (chosenColor == null) {
        return;
    }

    const stats = data.players[chosenColor];

    for (const [name, amount] of Object.entries(stats)) {
        document.getElementById(name).innerHTML = amount.toString();
    }
}

firebase.database().ref('/').on('value', (snapshot) => {
  data = snapshot.val();
  update();
});
        </script>
    </body>
</html>
