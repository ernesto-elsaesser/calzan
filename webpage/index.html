<!DOCTYPE html>
<html>
    <head>
        <title>Die Baustelle von Calzan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />

        <style>
            .player {
                width: 100px;
                height: 40px;
                font-weight: bold;
                display: inline-block;
            }
            #board {
                background-color: navy;
                width: 800px;
                height: 800px;
                margin: 20px auto;
                position: relative;
                border-radius: 400px;
            }
            #board * {
                position: absolute;
                transform: translate(-50%, -50%);
            }
            .tile { height: 150px; }
            .bandit { height: 30px; }
            .roll { font-size: 32px; }
            .city {
                height: 30px;
                width: 30px;
                border-radius: 50%;
            }
            .town {
                height: 40px;
                width: 40px;
                border-radius: 50%;
            }
            .road {
                height: 10px;
                width: 50px;
            }
            .port {
                font-size: 20px;
                color: white;
            }
        </style>
    </head>
    <body>
        <div style="text-align: center">
            <h3>SPIELER</h3>
            <div id="players"></div>
            <div style="margin: 20px">
                Holz: <span id="H">0</span> Lehm: <span id="L">0</span> Weizen: <span id="W">0</span> Schafe: <span id="S">0</span> Erz: <span id="E">0</span> Siegpunkte: <span id="P">0</span>
            </div>
            <div>WÃ¼rfel: <span id="dice">-</span></div>
            <div id="board"></div>
        </div>

        <script src="/__/firebase/8.10.1/firebase-app.js"></script>
        <script src="/__/firebase/8.10.1/firebase-database.js"></script>
        <script src="/__/firebase/init.js"></script>
        <script>

const players = document.getElementById("players");
const dice = document.getElementById("dice");
const board = document.getElementById("board");

const resourceLabels = [
    document.getElementById('H'),
    document.getElementById('L'),
    document.getElementById('W'),
    document.getElementById('S'),
    document.getElementById('E')
];

const portLabels = {
    'h': 'Holz',
    'l': 'Lehm',
    'w': 'Weizen',
    's': 'Schafe',
    'e': 'Erz'
};

var game = null;
var chosenColor = null;

function create(tag, cls, coords) {
    const element = document.createElement('img');
    element.className = cls;
    element.style.left = coords[0].toString() + 'px';
    element.style.top = coords[1].toString() + 'px';
    return element;
}

function update() {

    if (game == null) {
        return;
    }

    board.innerHTML = "";

    var row = 0;
    var col = 0;
    var c = null;
    var p = null;
    var r0 = null;
    var r1 = null;

    for (row = 1; row < 26; row += 2) {
        for (col = 0; col < 26; col += 2) {
            p = [col * 50, row * 30];
            c = game[row][col];

            if ('HLWSEX'.includes(c)) {
                const tile = create('img', 'tile', p);
                tile.src = 'img/' + c + '.svg';
                board.appendChild(tile);

                r = game[row+1].substring(col, col+2).trim();
                if (r0 != ' ') {
                    const roll = create('p', 'roll', p);
                    roll.innerHTML = r1 == ' ' ? r0 : r1 + r0;
                    board.appendChild(roll);
                }

                if (game[row-1][col-1] == '*') {
                    const bandit = create('img', 'bandit', p);
                    bandit.src = 'img/bandit.svg';
                    board.appendChild(bandit);
                }

            } else if ('hlwsex'.includes(c)) {

                // TODO img
                const port = create('p', 'port', p);
                if (c == 'x') {
                    port.innerHTML = '3:1';
                } else {
                    port.innerHTML = portLabels[c] + ' 2:1';
                }
                board.appendChild(port);

            }

        }

        /* TODO towns and roads!

        const className = info.city ? 'city' : 'town';
        const town = create('div', className, coords);
        town.style.backgroundColor = info.color;
        board.appendChild(town);

        const road = create('div', 'road', coords);
        road.style.backgroundColor = info.color;
        road.style.transform = 'rotate(' + rads.toString() + 'rad)';
        board.appendChild(road);

        */
    }

    dice.innerHTML = game[row].substring(0, 2).trim();
    row += 1;

    players.innerHTML = "";

    while (game[row]) {
        const color = game[row].substring(0, 16).trim();
        const button = document.createElement('button');
        button.className = 'player';
        button.style.backgroundColor = color;
        button.onclick = function() { chosenColor = color; update(); };
        players.appendChild(button);

        if (color = chosenColor) {
            button.innerHTML = '&horbar;&horbar;&horbar;&horbar;';
            for (col = 0; col < 5; col += 1) {
                resourceLabels[col].innerHTML = game[row][col + 16];
            }
        } else {
            button.innerHTML = '&nbsp';
        }

        row += 1;
    }
}

firebase.database().ref('/game').on('value', (snapshot) => {
  game = snapshot.val().split(/\n/);
  update();
});
        </script>
    </body>
</html>
